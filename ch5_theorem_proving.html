
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Chapter 5: Bounded Formal Verification &#8212; Rigor and Reasoning in Research Software (R3Sw)</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-V7VKREZ5MB"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-V7VKREZ5MB');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-V7VKREZ5MB');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'ch5_theorem_proving';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Closing Remarks: Climbing the Ladder of Rigor" href="closing_remarks.html" />
    <link rel="prev" title="Chapter 4: Property-Based Testing" href="ch4_property_based_testing.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="welcome.html">
  
  
  
  
  
  
    <p class="title logo__title">Rigor and Reasoning in Research Software (R3Sw)</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="welcome.html">
                    Welcome
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ch1_code_and_fix.html">Chapter 1: Code and Fix</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch2_reasoning.html">Chapter 2: Reasoning About Code</a></li>

<li class="toctree-l1"><a class="reference internal" href="ch3_unit_testing.html">Chapter 3: Unit Testing</a></li>

<li class="toctree-l1"><a class="reference internal" href="ch4_property_based_testing.html">Chapter 4: Property-Based Testing</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Chapter 5: Bounded Formal Verification</a></li>
<li class="toctree-l1"><a class="reference internal" href="closing_remarks.html">Closing Remarks: Climbing the Ladder of Rigor</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/alperaltuntas/R3Sw/blob/main/notebooks/ch5_theorem_proving.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/ch5_theorem_proving.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Chapter 5: Bounded Formal Verification</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-bounded">Why ‚ÄúBounded‚Äù?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-z3-solver">The Z3 Solver</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#declaring-variables">Declaring Variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encoding-and-checking-constraints">Encoding and Checking Constraints</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sat-vs-unsat">sat vs. unsat</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#operators">Operators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-1">Exercise 3.1:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-2">Exercise 3.2:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#declarative-style">Declarative Style</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-specs-to-proofs">From Specs to Proofs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#real-vs-floating-point">Real vs Floating-Point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#real-or-floating-point">Real or Floating-Point?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#back-to-the-heat-equation-solver">Back to the Heat Equation Solver</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#telescoping-property">Telescoping Property</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#core-procedures-as-constraints">Core Procedures as Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conservation">Conservation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#symmetry">Symmetry</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#monotonicity">Monotonicity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#positivity">Positivity</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-we-just-did">What we just did</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations">Limitations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="chapter-5-bounded-formal-verification">
<h1>Chapter 5: Bounded Formal Verification<a class="headerlink" href="#chapter-5-bounded-formal-verification" title="Link to this heading">#</a></h1>
<p>Unit tests (Ch.3) and property-based tests (Ch.4) give us confidence, but they still sample the input space.</p>
<blockquote>
<div><p>Testing can be used to show the presence of bugs, but never to show their absence. - Edsger W. Dijkstra</p>
</div></blockquote>
<p>Our next step is <em>bounded formal verification:</em> We‚Äôll:</p>
<ul class="simple">
<li><p>Encode our computations and check properties.</p></li>
<li><p>Use a tool (Z3) to reason symbolically about all possible inputs within a bounded scope.</p></li>
<li><p>Explore the strengths and the limits of this technique, and see how it may complement testing.</p></li>
</ul>
<p><strong>Formal verification:</strong> Using mathematical reasoning to prove or disprove the correctness of a program with respect to a specification.</p>
<p><strong>Bounded formal verification:</strong> Checking properties over a bounded set of problem sizes or input ranges.</p>
<ul class="simple">
<li><p>It can provide guarantees that testing alone cannot match. But these guarantees come at a cost:</p>
<ul>
<li><p><strong>Encoding effort:</strong> we must write down precise specifications and model the program‚Äôs behavior.</p></li>
<li><p><strong>Computational expense:</strong> solvers can become slow or intractable as problem size grows.</p></li>
</ul>
</li>
</ul>
<p><strong>Where it shines:</strong></p>
<ul class="simple">
<li><p>On critical routines where correctness is paramount.</p></li>
<li><p>On core algorithms where tests may miss subtle edge cases.</p></li>
</ul>
<p><strong>When it‚Äôs practical:</strong></p>
<ul class="simple">
<li><p>When code is designed with the right abstractions, decompositions, and specifications.</p></li>
</ul>
<p><strong>Additional benefit:</strong></p>
<ul class="simple">
<li><p>The act of writing specifications and reasoning about them often exposes ambiguities, hidden assumptions, or gaps in our understanding of the problem itself.</p></li>
</ul>
<section id="why-bounded">
<h2>Why ‚ÄúBounded‚Äù?<a class="headerlink" href="#why-bounded" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Formal methods rarely scale to arbitrarily large programs or inputs.</p></li>
<li><p>For instance, we might only prove properties of our heat-equation solver for small meshes (e.g., 10‚Äì100 points).</p></li>
<li><p>Yet this is often enough, thanks to the small-scope hypothesis (Daniel Jackson):</p></li>
</ul>
<blockquote>
<div><p>A high proportion of bugs can be found by checking a program for all inputs within some small scope.</p>
</div></blockquote>
<p><img alt="Scaling Limits" src="_images/coverage.png" /></p>
<p>Even such bounded proofs can expose subtle bugs or confirm that a property is guaranteed.</p>
</section>
<section id="the-z3-solver">
<h2>The Z3 Solver<a class="headerlink" href="#the-z3-solver" title="Link to this heading">#</a></h2>
<p>Z3 is a popular solver developed by Microsoft Research and is widely used in both academia and industry.</p>
<p>Use cases include:</p>
<ul class="simple">
<li><p>Bug finding and program analysis.</p></li>
<li><p>Verification of software and hardware.</p></li>
<li><p>Compilers and optimizers.</p></li>
<li><p>Tool development. See <a class="reference external" href="https://github.com/ESMCI/visualCaseGen">visualCaseGen</a> for an example.</p></li>
</ul>
<p>Here, we use Z3 to prove properties of our heat equation solver by encoding its behavior and desired properties as logical formulas.</p>
<p>Workflow:</p>
<ol class="arabic simple">
<li><p>Declare symbolic variables (e.g., <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">res</span></code>).</p></li>
<li><p>Encode constraints:</p>
<ul class="simple">
<li><p>Preconditions <code class="docutils literal notranslate"><span class="pre">P</span></code></p></li>
<li><p>The effects of the <code class="docutils literal notranslate"><span class="pre">code</span></code>.</p></li>
<li><p>Desired postconditions <code class="docutils literal notranslate"><span class="pre">Q</span></code>.</p></li>
</ul>
</li>
<li><p>Ask Z3 to check <code class="docutils literal notranslate"><span class="pre">{P}</span> <span class="pre">[code]</span> <span class="pre">{Q}</span></code> by searching for a counterexample:</p>
<ul class="simple">
<li><p>If Z3 finds one, the property does not hold.</p></li>
<li><p>If none exist, the property is proven.</p></li>
</ul>
</li>
</ol>
<p><em><strong>Key advantage:</strong></em></p>
<ul class="simple">
<li><p>Testing samples <em>some</em> inputs.</p></li>
<li><p>Z3 reasons symbolically over <em>all</em> inputs within the specified bounds in one go.</p></li>
</ul>
<section id="declaring-variables">
<h3>Declaring Variables<a class="headerlink" href="#declaring-variables" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Z3 provides symbolic types: integers, reals, booleans, bit-vectors, arrays, strings, and more.</p></li>
<li><p>These are <em>not ordinary variables</em> with concrete values.</p></li>
<li><p>They represent <em>all possible values</em> of that type.</p></li>
<li><p>They become meaningful when we add constraints over them.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">z3</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Real</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Real</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Multiple variables can be declared at once:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">z3</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bools</span><span class="p">,</span> <span class="n">Ints</span><span class="p">,</span> <span class="n">Reals</span>

<span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Bools</span><span class="p">(</span><span class="s1">&#39;p q&#39;</span><span class="p">)</span>
<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">Ints</span><span class="p">(</span><span class="s1">&#39;i j k&#39;</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s1">&#39;x y z res&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can also create arrays programmatically using list comprehensions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="n">Real</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;F</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">F</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(F0, F1, F9)
</pre></div>
</div>
</div>
</div>
<p>Here:</p>
<ul class="simple">
<li><p>The strings on the RHS are names Z3 uses internally to identify the variables.</p></li>
<li><p>The Python variables on the LHS are what we‚Äôll use in our constraints and properties.</p></li>
<li><p>They don‚Äôt have to match, but keeping them consistent avoids confusion.</p></li>
</ul>
</section>
<section id="encoding-and-checking-constraints">
<h3>Encoding and Checking Constraints<a class="headerlink" href="#encoding-and-checking-constraints" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Once we have symbolic variables, we can express logical formulas (constraints) over them.</p></li>
<li><p>Constraints model:</p>
<ul>
<li><p>preconditions,</p></li>
<li><p>program logic and computations,</p></li>
<li><p>postconditions.</p></li>
</ul>
</li>
<li><p>We add constraints to a Z3 <code class="docutils literal notranslate"><span class="pre">Solver</span></code> instance.</p></li>
<li><p>We then ask the solver whether the constraints are satisfiable.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">z3</span><span class="w"> </span><span class="kn">import</span> <span class="n">Solver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">z3</span><span class="w"> </span><span class="kn">import</span> <span class="n">And</span><span class="p">,</span> <span class="n">Or</span><span class="p">,</span> <span class="n">Not</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s1">&#39;x y&#39;</span><span class="p">)</span>

<span class="n">constraints</span> <span class="o">=</span> <span class="n">Or</span><span class="p">([</span>
    <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">3</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>  <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">,</span>
    <span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="mi">3</span> <span class="o">&gt;</span> <span class="mi">100</span>
<span class="p">])</span>

<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>sat</b></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">[y = 0, x = -6]</div></div>
</div>
<section id="sat-vs-unsat">
<h4>sat vs. unsat<a class="headerlink" href="#sat-vs-unsat" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Satisfiable</strong> means there is at least one assignment of values to the variables that satisfies all the constraints.</p></li>
<li><p><strong>Unsatisfiable</strong> means there is no assignment of values to the variables that satisfies all the constraints.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">z3</span><span class="w"> </span><span class="kn">import</span> <span class="n">sat</span><span class="p">,</span> <span class="n">unsat</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="operators">
<h3>Operators<a class="headerlink" href="#operators" title="Link to this heading">#</a></h3>
<p>Z3 uses standard Python arithmetic and comparison operators.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s1">&#39;x y&#39;</span><span class="p">)</span>

<span class="c1"># Arithmetic</span>
<span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="n">x</span> <span class="o">-</span> <span class="n">y</span>
<span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
<span class="n">x</span> <span class="o">/</span> <span class="n">y</span>
<span class="n">x</span> <span class="o">+=</span> <span class="n">y</span>
<span class="n">x</span> <span class="o">**</span> <span class="n">y</span>

<span class="c1"># Comparison</span>
<span class="n">x</span> <span class="o">!=</span> <span class="n">y</span>
<span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span>
<span class="n">x</span> <span class="o">&lt;=</span> <span class="n">y</span>
<span class="o">...</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<p>For logical operations, Z3 provides special functions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">z3</span><span class="w"> </span><span class="kn">import</span> <span class="n">And</span><span class="p">,</span> <span class="n">Or</span><span class="p">,</span> <span class="n">Not</span><span class="p">,</span> <span class="n">Implies</span><span class="p">,</span> <span class="n">If</span>
</pre></div>
</div>
</div>
</div>
<p>Similarly, for some other operations, Z3 provides special functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">z3</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sqrt</span><span class="p">,</span> <span class="n">Abs</span><span class="p">,</span> <span class="n">Concat</span><span class="p">,</span> <span class="n">SubString</span>
</pre></div>
</div>
</div>
</div>
<p>But some kinds of mathematics fall outside its built-in theories:</p>
<ul>
<li><p>Transcendental functions: sin, cos, tan, exp, log</p>
<p>(But you can approximate or axiomatize them.)</p>
</li>
</ul>
</section>
<section id="exercise-3-1">
<h3>Exercise 3.1:<a class="headerlink" href="#exercise-3-1" title="Link to this heading">#</a></h3>
<p>Using Z3, find the root(s) of the equation:</p>
<p>ùë•¬≤ - 5*x + 6= 0.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Real</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> 
    <span class="c1"># add your constraint(s) here</span>
<span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>sat</b></div></div>
</div>
</section>
<section id="exercise-3-2">
<h3>Exercise 3.2:<a class="headerlink" href="#exercise-3-2" title="Link to this heading">#</a></h3>
<p>Using Z3, find the equilibrium surface temperature of a simple planet modeled by the equation:</p>
<p>(1 - Œ±) S / 4 = œÉT‚Å¥</p>
<p>Find:</p>
<ul class="simple">
<li><p>T (the equilibrium temperature in Kelvin)</p></li>
</ul>
<p>Given values:</p>
<ul class="simple">
<li><p>Œ± = 0.3 (the albedo, i.e., the fraction of sunlight reflected)</p></li>
<li><p>S = 1361 W/m¬≤ (the solar constant - incoming solar radiation)</p></li>
<li><p>œÉ = 5.67 √ó 10‚Åª‚Å∏ W/m¬≤K‚Å¥ (the Stefan-Boltzmann constant)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="n">a</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s1">&#39;a S sigma T&#39;</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="c1"># add your constraint(s) here</span>
<span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>sat</b></div></div>
</div>
</section>
<section id="declarative-style">
<h3>Declarative Style<a class="headerlink" href="#declarative-style" title="Link to this heading">#</a></h3>
<p>Z3 is declarative: you express <em>what must hold</em>, not how to compute.
That means:</p>
<ul class="simple">
<li><p>You don‚Äôt <em>assign</em> values to variables.</p></li>
<li><p>You constrain them with equations, inequalities, or logical relations.</p></li>
</ul>
<p>For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span>        <span class="c1"># a Boolean formula (not an assignment)</span>
<span class="n">y</span> <span class="o">&gt;=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>    <span class="c1"># another Boolean formula</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">y &ge; x + 1</div></div>
</div>
<p>On their own, these Boolean formulas don‚Äôt do anything, but once added to a solver, Z3 will try to find values of <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> that make them true.</p>
<p><em><strong>questions?</strong></em></p>
</section>
<section id="from-specs-to-proofs">
<h3>From Specs to Proofs<a class="headerlink" href="#from-specs-to-proofs" title="Link to this heading">#</a></h3>
<p>Let‚Äôs revisit our simple <code class="docutils literal notranslate"><span class="pre">div</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span>           <span class="c1"># precondition</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>             <span class="c1"># code</span>
    <span class="k">assert</span> <span class="n">res</span> <span class="o">*</span> <span class="n">y</span> <span class="o">==</span> <span class="n">x</span>     <span class="c1"># postcondition</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
</div>
</div>
<p>We can‚Äôt feed this Python directly to Z3, but we can encode the same idea declaratively:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">div</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>          <span class="c1"># precondition</span>
        <span class="n">res</span> <span class="o">==</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">,</span>    <span class="c1"># code</span>
        <span class="n">res</span> <span class="o">*</span> <span class="n">y</span> <span class="o">==</span> <span class="n">x</span>     <span class="c1"># postcondition</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we can check:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a solver:</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="c1"># Declare symbolic variables:</span>
<span class="n">res</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s1">&#39;res x y&#39;</span><span class="p">)</span>

<span class="c1"># call div(res, x, y) with symbolic variables:</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">div</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

<span class="c1"># Check if the div constraints are satisfiable:</span>
<span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>sat</b></div></div>
</div>
<p>This just tells us ‚Äúthere exists at least one input where it works.‚Äù</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">[y = -1, x = 0, res = 0, /0 = [else &rarr; 0]]</div></div>
</div>
<p>To prove it works for all inputs, we flip the logic:</p>
<ul class="simple">
<li><p>Find an assignment of variables that violate the postcondition.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">z3</span><span class="w"> </span><span class="kn">import</span> <span class="n">Not</span>

<span class="k">def</span><span class="w"> </span><span class="nf">div</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">And</span><span class="p">(</span>
        <span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">res</span> <span class="o">==</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">,</span>
        <span class="n">Not</span><span class="p">(</span><span class="n">res</span> <span class="o">*</span> <span class="n">y</span> <span class="o">==</span> <span class="n">x</span><span class="p">)</span>   <span class="c1"># negated postcondition</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a solver:</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="c1"># Declare symbolic variables:</span>
<span class="n">res</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s1">&#39;res x y&#39;</span><span class="p">)</span>

<span class="c1"># *call* div(res, x, y) with symbolic variables:</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">div</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

<span class="c1"># Check if the div constraints are satisfiable:</span>
<span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>unsat</b></div></div>
</div>
<p>Now Z3 confirms: there are no inputs (with y != 0) that break the postcondition, so the property holds universally, at least in real arithmetic.</p>
</section>
<section id="real-vs-floating-point">
<h3>Real vs Floating-Point<a class="headerlink" href="#real-vs-floating-point" title="Link to this heading">#</a></h3>
<p>Note that we used Reals. Real arithmetic is exact; floating-point is not.
That‚Äôs why Z3 didn‚Äôt <em>see</em> the earlier 7/25 counterexample.</p>
<ul class="simple">
<li><p>Reals are good for proving <em>conceptual correctness</em> and mathematical properties of algorithms.</p></li>
<li><p>Floating-point (<code class="docutils literal notranslate"><span class="pre">FP</span></code> in Z3) lets you model IEEE-754 semantics, but is heavier and harder to reason about exhaustively.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">z3</span><span class="w"> </span><span class="kn">import</span> <span class="n">Float16</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">FPVal</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">z3</span><span class="w"> </span><span class="kn">import</span> <span class="n">fpAbs</span><span class="p">,</span> <span class="n">fpIsZero</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">z3</span><span class="w"> </span><span class="kn">import</span> <span class="n">fpIsInf</span><span class="p">,</span> <span class="n">fpIsNaN</span><span class="p">,</span> <span class="n">fpIsSubnormal</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># choose a format</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">Float16</span><span class="p">()</span> <span class="c1"># or Float32(), Float64()</span>

<span class="n">rtol</span> <span class="o">=</span> <span class="n">FPVal</span><span class="p">(</span><span class="mf">1e-1</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">approx_equal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># |a - b| &lt;= rtol * |b|</span>
    <span class="k">return</span> <span class="n">fpAbs</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">rtol</span> <span class="o">*</span> <span class="n">fpAbs</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">div</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">Not</span><span class="p">(</span><span class="n">fpIsZero</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>               <span class="c1"># precondition</span>
        <span class="n">res</span> <span class="o">==</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">,</span>                   <span class="c1"># code</span>
        <span class="n">Not</span><span class="p">(</span><span class="n">approx_equal</span><span class="p">(</span><span class="n">res</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)),</span>  <span class="c1"># postcondition</span>
    <span class="p">]</span>

<span class="c1"># Create a solver:</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="c1"># Declare symbolic variables:</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">FP</span><span class="p">(</span><span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">FP</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">FP</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>

<span class="c1"># call div(res, x, y) with symbolic variables:</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">div</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sat
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">[y = -1.998046875*(2**14),
 x = -1.501953125*(2**-13),
 res = +0.0]</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># *** Cheat sheet for necessary FP preconditions ***</span>

<span class="c1"># *Prevent NaNs*</span>
<span class="c1"># Not(fpIsNaN(x)), Not(fpIsNaN(y)),</span>
<span class="c1"># </span>
<span class="c1"># *Prevent Infs*</span>
<span class="c1"># Not(fpIsInf(x)), Not(fpIsInf(y)),</span>
<span class="c1"># </span>
<span class="c1"># *Prevent overflows, underflows, subnormals* (not recommended)</span>
<span class="c1"># Not(fpIsInf(res * y)), Not(fpIsSubnormal(res)), Implies(fpIsZero(res), fpIsZero(x)),</span>
</pre></div>
</div>
</div>
</div>
<p>Even for such simple code, this demonstrates how formal reasoning can uncover subtle edge cases that you may not have anticipated or that tests might miss.</p>
</section>
<section id="real-or-floating-point">
<h3>Real or Floating-Point?<a class="headerlink" href="#real-or-floating-point" title="Link to this heading">#</a></h3>
<p>For our purposes, reasoning in reals is preferable because:</p>
<ul class="simple">
<li><p>It‚Äôs simpler and faster for Z3 to handle.</p></li>
<li><p>It abstracts away round-off details and lets us focus on <strong>conceptual correctness</strong>, which is something generally overshadowed by FP complications.</p></li>
<li><p>Floating-point issues can be handled later with testing or targeted analysis.</p></li>
</ul>
<p>Note that, if a program is incorrect over the reals, it will also be incorrect in floating-point.</p>
<p><em><strong>questions?</strong></em></p>
</section>
</section>
<section id="back-to-the-heat-equation-solver">
<h2>Back to the Heat Equation Solver<a class="headerlink" href="#back-to-the-heat-equation-solver" title="Link to this heading">#</a></h2>
<p>Using this approach, we can systematically reason about our heat equation solver:</p>
<ol class="arabic simple">
<li><p>Declare symbolic variables.</p></li>
<li><p>Encode the solver declaratively as constraints:</p>
<ul class="simple">
<li><p>Preconditions</p></li>
<li><p>Core Procedures</p></li>
<li><p>Postconditions.</p></li>
</ul>
</li>
<li><p>Ask Z3 to prove properties by checking satisfiability of the <em>negation</em> of the desired properties.</p></li>
</ol>
<section id="telescoping-property">
<h3>Telescoping Property<a class="headerlink" href="#telescoping-property" title="Link to this heading">#</a></h3>
<p>As a first step, let‚Äôs prove the <strong>telescoping property of divergence</strong>: The sum of the divergence over all cells equals the net flux through the boundaries.</p>
<p><span class="math notranslate nohighlight">\(\qquad
\sum_{i=0}^{N-1} (\nabla \cdot F)_i = F_0 - F_N
\qquad\)</span></p>
<p>Recall the divergence function and the telescoping property (assertions omitted for brevity):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">divergence</span><span class="p">(</span><span class="n">c_out</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dxt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the divergence of face quantities (f) and store in (c_out).&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_out</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Size mismatch&quot;</span>
    <span class="k">assert</span> <span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Non-positive dx&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c_out</span><span class="p">)):</span>
        <span class="n">c_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">dx</span>

<span class="k">def</span><span class="w"> </span><span class="nf">telescoping</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the finite volume telescoping property.&quot;&quot;&quot;</span>
    <span class="n">total_divergence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">boundary_flux</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">total_divergence</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="n">boundary_flux</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To express these functions in Z3:</p>
<ul class="simple">
<li><p>We‚Äôll define corresponding functions that operate on Z3 symbolic variables and return constraints representing their behavior.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">divergence</span><span class="p">(</span><span class="n">c_out</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the divergence of face quantities (f) and store in (c_out).&quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_out</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">c_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">dx</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">telescoping</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the finite volume telescoping property.&quot;&quot;&quot;</span>
    <span class="n">total_divergence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">boundary_flux</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">total_divergence</span> <span class="o">==</span> <span class="n">boundary_flux</span>
</pre></div>
</div>
</div>
</div>
<p>The two main differences between the imperative and declarative versions are:</p>
<ol class="arabic simple">
<li><p>The imperative version has assignments (e.g., c[i] = ‚Ä¶), while the declarative version uses equality constraints (e.g., c[i] == ‚Ä¶).</p></li>
<li><p>The imperative version uses approximate equality (approx), while the declarative version uses exact equality (==).</p></li>
</ol>
<p>Let‚Äôs now declare Z3 variables to represent the inputs and outputs of these functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># number of cells</span>
<span class="n">dx</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">kappa</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s1">&#39;dx dt kappa&#39;</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="n">Real</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">Real</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;c</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can set up a solver to check the telescoping property:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a solver instance:</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="c1"># Preconditions:</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kappa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Preconditions:physical constraints</span>

<span class="c1"># Code: divergence computation</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">divergence</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>

<span class="c1"># Postcondition:</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Not</span><span class="p">(</span><span class="n">telescoping</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dx</span><span class="p">)))</span> 

<span class="c1"># Check satisfiability:</span>
<span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>unsat</b></div></div>
</div>
<p>The Z3 solver confirms <code class="docutils literal notranslate"><span class="pre">unsat</span></code>: there are no inputs that violate the telescoping property, so it holds universally for all valid inputs where N=3. Let‚Äôs attempt to increase N and see how far we can go before Z3 struggles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">prove_telescoping</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="c1"># Declare symbolic variables:</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">Real</span><span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="n">Real</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">Real</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;c</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>

    <span class="c1"># Create and configure solver:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kappa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Preconditions:physical constraints</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">divergence</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>      <span class="c1"># code: divergence</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Not</span><span class="p">(</span><span class="n">telescoping</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dx</span><span class="p">)))</span><span class="c1"># Postcondition: telescoping property</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">unsat</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">prove_telescoping</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;N=</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s1">, proved?=</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s1">, time=</span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Stop if it takes too long</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=3, proved?=True, time=0.005280017852783203
N=13, proved?=True, time=0.009983062744140625
N=23, proved?=True, time=0.023489952087402344
N=33, proved?=True, time=0.05666399002075195
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=43, proved?=True, time=0.05717897415161133
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=53, proved?=True, time=0.06911897659301758
N=63, proved?=True, time=0.08230924606323242
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=73, proved?=True, time=0.10722517967224121
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=83, proved?=True, time=0.13048601150512695
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=93, proved?=True, time=0.14644503593444824
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=103, proved?=True, time=0.1917281150817871
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=113, proved?=True, time=0.22432374954223633
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=123, proved?=True, time=0.25306177139282227
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=133, proved?=True, time=0.31859803199768066
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=143, proved?=True, time=0.36832308769226074
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=153, proved?=True, time=0.4084649085998535
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=163, proved?=True, time=0.4642808437347412
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=173, proved?=True, time=0.5260672569274902
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=183, proved?=True, time=0.6145071983337402
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N=193, proved?=True, time=0.6554920673370361
</pre></div>
</div>
</div>
</div>
</section>
<section id="core-procedures-as-constraints">
<h3>Core Procedures as Constraints<a class="headerlink" href="#core-procedures-as-constraints" title="Link to this heading">#</a></h3>
<p>Let‚Äôs re-express all of the core procedures of the heat equation solver
as <strong>constraint generators</strong>: functions that take Z3 variables and return Z3 constraints representing
the original procedures‚Äô behavior.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">apply_bc</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">bc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply BCs by overriding first and last face quantities (f).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">bc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">bc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">diffusive_flux</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a cell field (c), compute the diffusive flux (f).&quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="n">kappa</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">dx</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">divergence</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">dx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the divergence of face quantities (f) and store in (c).&quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">dx</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">step_heat_eqn</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">divF</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Advance cell field u by one time step using explicit Euler method.&quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u0</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">u1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">u0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">divF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>We‚Äôll use these declarative versions of the core computations to model the heat equation time step and prove properties about it.</p>
<p>Having specified these core computations declaratively, now let‚Äôs define the symbolic variables. In unit tests, we handpicked specific inputs. In property-based tests, we sampled many inputs randomly. Here, we define symbolic variables that represent <em>all possible</em> inputs within specified bounds.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the parameters</span>
<span class="n">dx</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">kappa</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s2">&quot;dx dt kappa&quot;</span><span class="p">)</span>

<span class="c1"># Boundary conditions</span>
<span class="n">bc</span> <span class="o">=</span> <span class="n">Reals</span><span class="p">(</span><span class="s2">&quot;bc0 bc1&quot;</span><span class="p">)</span>

<span class="c1"># Define the vectors based on mesh size N</span>
<span class="k">def</span><span class="w"> </span><span class="nf">allocate_vectors</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">u_old</span> <span class="o">=</span> <span class="p">[</span><span class="n">Real</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;u_old_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
    <span class="n">u_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">Real</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;u_new_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
    <span class="n">divF</span> <span class="o">=</span> <span class="p">[</span><span class="n">Real</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;divF_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="n">Real</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">divF</span><span class="p">,</span> <span class="n">F</span>
</pre></div>
</div>
</div>
</div>
<p>We are now ready to state and prove more properties about our heat equation solver.</p>
</section>
<section id="conservation">
<h3>Conservation<a class="headerlink" href="#conservation" title="Link to this heading">#</a></h3>
<p>Recall the below encoding of the <strong>conservation property</strong> from the previous chapters:</p>
<p><span class="math notranslate nohighlight">\(
\sum_i u_i^{\,\text{new}}\,\Delta x = \sum_i u_i^{\,\text{old}}\,\Delta x + \Delta t\,\bigl(bc_0 - bc_1\bigr)
\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">heat_is_conserved</span><span class="p">(</span><span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">bc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if heat is conserved.&quot;&quot;&quot;</span>
    <span class="n">lhs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u_new</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
    <span class="n">rhs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u_old</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">bc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">bc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="c1"># Allocate vectors</span>
<span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">divF</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">allocate_vectors</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Positive, arbitrary parameters</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kappa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Model the heat equation time step</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">apply_bc</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">bc</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">diffusive_flux</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">divergence</span><span class="p">(</span><span class="n">divF</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">step_heat_eqn</span><span class="p">(</span><span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">divF</span><span class="p">,</span> <span class="n">dt</span><span class="p">))</span>

<span class="c1"># Attempt to disprove conservation</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Not</span><span class="p">(</span><span class="n">heat_is_conserved</span><span class="p">(</span><span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">bc</span><span class="p">)))</span>

<span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>unsat</b></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">unsat</span></code> result indicates that Z3 is unable to find any counterexample that violates the conservation property. As such, we have proven that the conservation property holds for all possible inputs (for real arithmetic and N=5).</p>
<p><em><strong>Note</strong></em></p>
<ul class="simple">
<li><p>While we checked this proof for just one time step, it‚Äôs an arbitrary timestep that represents <em>any</em> step of the simulation.</p></li>
<li><p>By induction, if each step conserves heat, the entire simulation does as well. (Think, loop invariant.)</p></li>
<li><p>Though, this doesn‚Äôt account for truncation errors or floating-point round-off, which could accumulate over many steps in a real implementation.</p></li>
</ul>
</section>
<section id="symmetry">
<h3>Symmetry<a class="headerlink" href="#symmetry" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>If the initial state is symmetric, and the boundary fluxes are equal and opposite (antisymmetric),</p></li>
<li><p>Then, the updated state must also be symmetric.</p></li>
</ul>
<p>Let‚Äôs encode:</p>
<ul class="simple">
<li><p>symmetry: <span class="math notranslate nohighlight">\(u_{i} = u_{N-1-i}\)</span> for all <span class="math notranslate nohighlight">\(i &lt;N/2\)</span>.</p></li>
<li><p>Antisymmetric BCs: <span class="math notranslate nohighlight">\(F_0 = -F_{N}\)</span>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">is_symmetric</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">And</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">u</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="c1"># Allocate vectors</span>
<span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">divF</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">allocate_vectors</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Positive, arbitrary parameters</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kappa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># symmetric initial condition</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">is_symmetric</span><span class="p">(</span><span class="n">u_old</span><span class="p">))</span>

<span class="c1"># Apply antisymmetric, arbitrary BCs</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="n">bc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Model the heat equation time step</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">apply_bc</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">bc</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">diffusive_flux</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">divergence</span><span class="p">(</span><span class="n">divF</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">step_heat_eqn</span><span class="p">(</span><span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">divF</span><span class="p">,</span> <span class="n">dt</span><span class="p">))</span>

<span class="c1"># Attempt to disprove symmetry preservation</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Not</span><span class="p">(</span><span class="n">is_symmetric</span><span class="p">(</span><span class="n">u_new</span><span class="p">)))</span>

<span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>unsat</b></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">unsat</span></code> result indicates that Z3 is unable to find any counterexample that violates the symmetry property. As such, we have proven that the symmetry property holds for all possible inputs (for real arithmetic and N=5).</p>
</section>
<section id="monotonicity">
<h3>Monotonicity<a class="headerlink" href="#monotonicity" title="Link to this heading">#</a></h3>
<p>Diffusion smooths. One way to express this intuition discretely is through monotonicity preservation:
if a temperature profile is nondecreasing at the start of a step, it should remain so after the update.
In other words, diffusion should not create new inversions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">is_nondecreasing</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">And</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="c1"># Allocate vectors</span>
<span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">divF</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">allocate_vectors</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Positive, arbitrary parameters</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kappa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># insulated boundaries</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Model the heat equation time step</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">apply_bc</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">bc</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">diffusive_flux</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">divergence</span><span class="p">(</span><span class="n">divF</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">step_heat_eqn</span><span class="p">(</span><span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">divF</span><span class="p">,</span> <span class="n">dt</span><span class="p">))</span>

<span class="c1"># nondecreasing initial profile</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">is_nondecreasing</span><span class="p">(</span><span class="n">u_old</span><span class="p">))</span>

<span class="c1"># ask Z3 to find a counterexample that breaks monotonicity</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Not</span><span class="p">(</span><span class="n">is_nondecreasing</span><span class="p">(</span><span class="n">u_new</span><span class="p">)))</span>

<span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>sat</b></div></div>
</div>
<p>The solver returns <code class="docutils literal notranslate"><span class="pre">sat</span></code>, indicating that Z3 has found a counterexample that violates the monotonicity property.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">[u_new_1 = -1,
 divF_4 = 0,
 divF_0 = 1,
 F1 = -1,
 dx = 1,
 u_new_4 = 0,
 bc1 = 0,
 kappa = 1,
 u_new_0 = 0,
 u_new_2 = 0,
 divF_3 = 0,
 divF_1 = -1,
 dt = 1,
 u_new_3 = 0,
 u_old_4 = 0,
 u_old_1 = 0,
 u_old_3 = 0,
 F2 = 0,
 F5 = 0,
 u_old_0 = -1,
 divF_2 = 0,
 bc0 = 0,
 F3 = 0,
 F0 = 0,
 u_old_2 = 0,
 F4 = 0,
 /0 = [(0, 1) &rarr; 0,
      (-1, 1) &rarr; -1,
      (1, 1) &rarr; 1,
      else &rarr; If(&#957;<sub>0</sub> = 0 &and; &#957;<sub>1</sub> = 1 &or; &not;(&#957;<sub>0</sub> = -1 &and; &#957;<sub>1</sub> = 1), 0, -1)]]</div></div>
</div>
<p>The counterexample provided by Z3 shows specific values for the parameters and initial conditions where the property fails. This insight can guide us in refining our model or understanding the limitations of the diffusion process under certain conditions:</p>
<p>Looking closely at the counterexample, we see that <code class="docutils literal notranslate"><span class="pre">dt</span></code> is quite large relative to <code class="docutils literal notranslate"><span class="pre">dx</span></code> and <code class="docutils literal notranslate"><span class="pre">kappa</span></code>, leading to instability</p>
<p>Try introducing the stability condition and see if that helps prove monotonicity:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">&lt;=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dx</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">kappa</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">dt &le; (dx&middot;dx)/(2&middot;kappa)</div></div>
</div>
</section>
<section id="positivity">
<h3>Positivity<a class="headerlink" href="#positivity" title="Link to this heading">#</a></h3>
<p>We expect that, given a non-negative initial temperature distribution and non-negative boundary conditions, the temperature remains non-negative after one time step. Below is an expression of this property in Z3:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">all_positive</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All cell values are non-negative.&quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">And</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span>

<span class="c1"># Allocate vectors</span>
<span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">divF</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">allocate_vectors</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Positive, arbitrary parameters</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kappa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dt</span> <span class="o">&lt;=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dx</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">kappa</span><span class="p">))</span>  <span class="c1"># r &lt;= 1/2</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Model the heat equation time step</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">apply_bc</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">bc</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">diffusive_flux</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">divergence</span><span class="p">(</span><span class="n">divF</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">step_heat_eqn</span><span class="p">(</span><span class="n">u_old</span><span class="p">,</span> <span class="n">u_new</span><span class="p">,</span> <span class="n">divF</span><span class="p">,</span> <span class="n">dt</span><span class="p">))</span>

<span class="c1"># non-negative initial profile and BCs</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">all_positive</span><span class="p">(</span><span class="n">u_old</span><span class="p">))</span>

<span class="c1"># ask Z3 to find a counterexample that produces negative temperature</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Not</span><span class="p">(</span><span class="n">all_positive</span><span class="p">(</span><span class="n">u_new</span><span class="p">)))</span>

<span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>unsat</b></div></div>
</div>
</section>
</section>
<section id="what-we-just-did">
<h2>What we just did<a class="headerlink" href="#what-we-just-did" title="Link to this heading">#</a></h2>
<p>We re-expressed the solver‚Äôs core procedures as constraint generators and used Z3 to:</p>
<ul class="simple">
<li><p>Prove universal identities (telescoping, conservation).</p></li>
<li><p>Find counterexamples when preconditions are missing (monotonicity).</p></li>
<li><p>Confirm fixes by adding the right guards.</p></li>
</ul>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Scalability:</strong> Z3 can struggle with larger problem sizes or more complex properties.</p></li>
<li><p><strong>Encoding effort:</strong> Writing accurate and complete specifications can be challenging.</p></li>
<li><p><strong>Theoretical limits:</strong> Some properties may be undecidable or intractable to prove.</p></li>
</ul>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>Yet, despite these limitations, the benefits of using Z3 for formal verification are significant:</p>
<ul class="simple">
<li><p>It uncovers subtle bugs that testing might miss.</p></li>
<li><p>It can provide strong guarantees about correctness within the specified bounds.</p></li>
<li><p>It encourages precise thinking about specifications and program behavior.</p></li>
</ul>
<p>While there is no one-size-fits-all solution, having multiple tools and techniques at our disposal allows us to mix and match approaches based on the specific needs and constraints of each project.</p>
<hr class="docutils" />
<p>R3Sw tutorial by Alper Altuntas (NSF NCAR). Sponsored by the BSSw Fellowship Program. ¬© 2025.</p>
<p>Cite as: Alper Altuntas, Deepak Cherian, Adrianna Foster, Manish Venumuddula, and Helen Kershaw. (2025). <em>‚ÄúRigor and Reasoning in Research Software (R3Sw) Tutorial.‚Äù</em> Retrieved from <a class="reference external" href="https://www.alperaltuntas.com/R3Sw">https://www.alperaltuntas.com/R3Sw</a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="ch4_property_based_testing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Chapter 4: Property-Based Testing</p>
      </div>
    </a>
    <a class="right-next"
       href="closing_remarks.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Closing Remarks: Climbing the Ladder of Rigor</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-bounded">Why ‚ÄúBounded‚Äù?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-z3-solver">The Z3 Solver</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#declaring-variables">Declaring Variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encoding-and-checking-constraints">Encoding and Checking Constraints</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sat-vs-unsat">sat vs. unsat</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#operators">Operators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-1">Exercise 3.1:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-2">Exercise 3.2:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#declarative-style">Declarative Style</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-specs-to-proofs">From Specs to Proofs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#real-vs-floating-point">Real vs Floating-Point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#real-or-floating-point">Real or Floating-Point?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#back-to-the-heat-equation-solver">Back to the Heat Equation Solver</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#telescoping-property">Telescoping Property</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#core-procedures-as-constraints">Core Procedures as Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conservation">Conservation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#symmetry">Symmetry</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#monotonicity">Monotonicity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#positivity">Positivity</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-we-just-did">What we just did</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations">Limitations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alper Altuntas, et al.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>